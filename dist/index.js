import{useState as e,useRef as t,useEffect as n}from"react";var o=function(){return o=Object.assign||function(e){for(var t,n=1,o=arguments.length;n<o;n++)for(var r in t=arguments[n])Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r]);return e},o.apply(this,arguments)};function r(e,t,n,o){return new(n||(n=Promise))(function(r,i){function a(e){try{c(o.next(e))}catch(e){i(e)}}function s(e){try{c(o.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?r(e.value):(t=e.value,t instanceof n?t:new n(function(e){e(t)})).then(a,s)}c((o=o.apply(e,t||[])).next())})}function i(e,t){var n,o,r,i={label:0,sent:function(){if(1&r[0])throw r[1];return r[1]},trys:[],ops:[]},a=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return a.next=s(0),a.throw=s(1),a.return=s(2),"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function s(s){return function(c){return function(s){if(n)throw new TypeError("Generator is already executing.");for(;a&&(a=0,s[0]&&(i=0)),i;)try{if(n=1,o&&(r=2&s[0]?o.return:s[0]?o.throw||((r=o.return)&&r.call(o),0):o.next)&&!(r=r.call(o,s[1])).done)return r;switch(o=0,r&&(s=[2&s[0],r.value]),s[0]){case 0:case 1:r=s;break;case 4:return i.label++,{value:s[1],done:!1};case 5:i.label++,o=s[1],s=[0];continue;case 7:s=i.ops.pop(),i.trys.pop();continue;default:if(!(r=i.trys,(r=r.length>0&&r[r.length-1])||6!==s[0]&&2!==s[0])){i=0;continue}if(3===s[0]&&(!r||s[1]>r[0]&&s[1]<r[3])){i.label=s[1];break}if(6===s[0]&&i.label<r[1]){i.label=r[1],r=s;break}if(r&&i.label<r[2]){i.label=r[2],i.ops.push(s);break}r[2]&&i.ops.pop(),i.trys.pop();continue}s=t.call(e,i)}catch(e){s=[6,e],o=0}finally{n=r=0}if(5&s[0])throw s[1];return{value:s[0]?s[1]:void 0,done:!0}}([s,c])}}}function a(e,t,n){if(n||2===arguments.length)for(var o,r=0,i=t.length;r<i;r++)!o&&r in t||(o||(o=Array.prototype.slice.call(t,0,r)),o[r]=t[r]);return e.concat(o||Array.prototype.slice.call(t))}"function"==typeof SuppressedError&&SuppressedError;var s,c=l;function l(){}l.mixin=function(e){var t=e.prototype||e;t.isWildEmitter=!0,t.on=function(e,t,n){this.callbacks=this.callbacks||{};var o=3===arguments.length,r=o?arguments[1]:void 0,i=o?arguments[2]:arguments[1];return i._groupName=r,(this.callbacks[e]=this.callbacks[e]||[]).push(i),this},t.once=function(e,t,n){var o=this,r=3===arguments.length,i=r?arguments[1]:void 0,a=r?arguments[2]:arguments[1];return this.on(e,i,function t(){o.off(e,t),a.apply(this,arguments)}),this},t.releaseGroup=function(e){var t,n,o,r;for(t in this.callbacks=this.callbacks||{},this.callbacks)for(n=0,o=(r=this.callbacks[t]).length;n<o;n++)r[n]._groupName===e&&(r.splice(n,1),n--,o--);return this},t.off=function(e,t){this.callbacks=this.callbacks||{};var n,o=this.callbacks[e];return o?1===arguments.length?(delete this.callbacks[e],this):(-1!==(n=o.indexOf(t))&&(o.splice(n,1),0===o.length&&delete this.callbacks[e]),this):this},t.emit=function(e){this.callbacks=this.callbacks||{};var t,n,o,r=[].slice.call(arguments,1),i=this.callbacks[e],a=this.getWildcardCallbacks(e);if(i)for(t=0,n=(o=i.slice()).length;t<n&&o[t];++t)o[t].apply(this,r);if(a)for(n=a.length,t=0,n=(o=a.slice()).length;t<n&&o[t];++t)o[t].apply(this,[e].concat(r));return this},t.getWildcardCallbacks=function(e){this.callbacks=this.callbacks||{};var t,n,o=[];for(t in this.callbacks)n=t.split("*"),("*"===t||2===n.length&&e.slice(0,n[0].length)===n[0])&&(o=o.concat(this.callbacks[t]));return o}},l.mixin(l),"undefined"!=typeof window&&(s=window.AudioContext||window.webkitAudioContext);var u=null,f="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},h=!!(f===f.window&&f.URL&&f.Blob&&f.Worker);function p(e,t){var n,o=this;if(t=t||{},h)return n=e.toString().trim().match(/^function\s*\w*\s*\([\w\s,]*\)\s*{([\w\W]*?)}$/)[1],new f.Worker(f.URL.createObjectURL(new f.Blob([n],{type:"text/javascript"})));this.self=t,this.self.postMessage=function(e){setTimeout(function(){o.onmessage({data:e})},0)},setTimeout(e.bind(t,t),0)}p.prototype.postMessage=function(e){var t=this;setTimeout(function(){t.self.onmessage({data:e})},0)};var d=p;class g{constructor(e,t){this.config={bufferLen:4096,numChannels:1,mimeType:"audio/wav",...t},this.recording=!1,this.callbacks={getBuffer:[],exportWAV:[]},this.context=e.context,this.node=(this.context.createScriptProcessor||this.context.createJavaScriptNode).call(this.context,this.config.bufferLen,this.config.numChannels,this.config.numChannels),this.node.onaudioprocess=e=>{if(this.recording){for(var t=[],n=0;n<this.config.numChannels;n++)t.push(e.inputBuffer.getChannelData(n));this.worker.postMessage({command:"record",buffer:t})}},e.connect(this.node),this.node.connect(this.context.destination);this.worker=new d(function(){let e,t,n,o=0,r=[];function i(){for(let e=0;e<t;e++)r[e]=[]}function a(e,t){let n=new Float32Array(t),o=0;for(let t=0;t<e.length;t++)n.set(e[t],o),o+=e[t].length;return n}function s(e,t,n){for(let o=0;o<n.length;o++)e.setUint8(t+o,n.charCodeAt(o))}this.onmessage=function(c){switch(c.data.command){case"init":l=c.data.config,e=l.sampleRate,t=l.numChannels,i(),n=e>48e3?48e3:e;break;case"record":!function(e){for(var n=0;n<t;n++)r[n].push(e[n]);o+=e[0].length}(c.data.buffer);break;case"exportWAV":!function(i){let c,l=[];for(let e=0;e<t;e++)l.push(a(r[e],o));c=2===t?function(e,t){let n=e.length+t.length,o=new Float32Array(n),r=0,i=0;for(;r<n;)o[r++]=e[i],o[r++]=t[i],i++;return o}(l[0],l[1]):l[0];let u=function(e){let o=new ArrayBuffer(44+2*e.length),r=new DataView(o);return s(r,0,"RIFF"),r.setUint32(4,36+2*e.length,!0),s(r,8,"WAVE"),s(r,12,"fmt "),r.setUint32(16,16,!0),r.setUint16(20,1,!0),r.setUint16(22,t,!0),r.setUint32(24,n,!0),r.setUint32(28,4*n,!0),r.setUint16(32,2*t,!0),r.setUint16(34,16,!0),s(r,36,"data"),r.setUint32(40,2*e.length,!0),function(e,t,n){for(let o=0;o<n.length;o++,t+=2){let r=Math.max(-1,Math.min(1,n[o]));e.setInt16(t,r<0?32768*r:32767*r,!0)}}(r,44,e),r}(function(t,n){if(n==e)return t;if(n>e)throw"downsampling rate show be smaller than original sample rate";var o=e/n,r=Math.round(t.length/o),i=new Float32Array(r),a=0,s=0;for(;a<i.length;){for(var c=Math.round((a+1)*o),l=0,u=0,f=s;f<c&&f<t.length;f++)l+=t[f],u++;i[a]=l/u,a++,s=c}return i}(c,n)),f=new Blob([u],{type:i});this.postMessage({command:"exportWAV",data:f})}(c.data.type);break;case"getBuffer":!function(){let e=[];for(let n=0;n<t;n++)e.push(a(r[n],o));this.postMessage({command:"getBuffer",data:e})}();break;case"clear":o=0,r=[],i()}var l}},{}),this.worker.postMessage({command:"init",config:{sampleRate:this.context.sampleRate,numChannels:this.config.numChannels}}),this.worker.onmessage=e=>{let t=this.callbacks[e.data.command].pop();"function"==typeof t&&t(e.data.data)}}record(){this.recording=!0}stop(){this.recording=!1}clear(){this.worker.postMessage({command:"clear"})}getBuffer(e){if(!(e=e||this.config.callback))throw new Error("Callback not set");this.callbacks.getBuffer.push(e),this.worker.postMessage({command:"getBuffer"})}exportWAV(e,t){if(t=t||this.config.mimeType,!(e=e||this.config.callback))throw new Error("Callback not set");this.callbacks.exportWAV.push(e),this.worker.postMessage({command:"exportWAV",type:t})}static forceDownload(e,t){let n=(window.URL||window.webkitURL).createObjectURL(e),o=window.document.createElement("a");o.href=n,o.download=t||"output.wav";let r=document.createEvent("Event");r.initEvent("click",!0,!0),o.dispatchEvent(r)}}let m,v,w=g;async function b({audioContext:e,errHandler:t,onStreamLoad:n}){try{const t=await navigator.mediaDevices.getUserMedia({audio:!0});return n&&n(),m=t,v=e.createMediaStreamSource(t),w=new g(v),w.record(),t}catch(e){console.log(e),t&&t()}}function k({exportWAV:e,wavCallback:t}){w.stop(),m.getAudioTracks()[0].stop(),e&&t&&w.exportWAV(e=>t(e)),w.clear()}var y,x=window.AudioContext||window.webkitAudioContext,A=window.SpeechRecognition||window.webkitSpeechRecognition;function C(l){var f=this,h=l.continuous,p=l.crossBrowser,d=l.googleApiKey,g=l.googleCloudRecognitionConfig,m=l.onStartSpeaking,v=l.onStoppedSpeaking,w=l.speechRecognitionProperties,A=void 0===w?{interimResults:!0}:w,C=l.timeout,R=void 0===C?1e4:C,S=l.useOnlyGoogleCloud,M=void 0!==S&&S,T=l.useLegacyResults,U=void 0===T||T,W=e(!1),E=W[0],L=W[1],B=t(),H=e([]),V=H[0],O=H[1],j=e([]),F=j[0],I=j[1],D=e(),P=D[0],_=D[1],N=e(""),q=N[0],z=N[1],G=t(),J=t();n(function(){var e;p||y||z("Speech Recognition API is only available on Chrome and Edge"),(null===(e=null===navigator||void 0===navigator?void 0:navigator.mediaDevices)||void 0===e?void 0:e.getUserMedia)||z("getUserMedia is not supported on this device/browser :("),!p&&!M||d||console.error("No google cloud API key was passed, google API will not be able to process speech"),B.current||(B.current=new x),U&&console.warn("react-hook-speech-to-text is using legacy results, pass useLegacyResults: false to the hook to use the new array of objects results. Legacy array of strings results will be removed in a future version.")},[]);var K=function(){return r(f,void 0,void 0,function(){var e,t,n,o;return i(this,function(r){switch(r.label){case 0:return!M&&y?(function(){if(y){h&&(y.continuous=!0);var e=A||{},t=e.grammars,n=e.interimResults,o=e.lang,r=e.maxAlternatives;t&&(y.grammars=t),o&&(y.lang=o),y.interimResults=n||!1,y.maxAlternatives=r||1,y.start(),y.onresult=function(e){var t=e.results[e.results.length-1],o=t[0].transcript,r=Math.floor(Date.now()/1e3);if(n)if(t.isFinal)_(void 0),I(function(e){return a(a([],e,!0),[{transcript:o,timestamp:r}],!1)}),O(function(e){return a(a([],e,!0),[o],!1)});else{for(var i="",s=e.resultIndex;s<e.results.length;s++)i+=e.results[s][0].transcript;_(i)}else I(function(e){return a(a([],e,!0),[{transcript:o,timestamp:r}],!1)}),O(function(e){return a(a([],e,!0),[o],!1)})},y.onaudiostart=function(){return L(!0)},y.onend=function(){L(!1)}}}(),[2]):p||M?("suspended"===(null===(n=B.current)||void 0===n?void 0:n.state)&&(null===(o=B.current)||void 0===o||o.resume()),[4,b({errHandler:function(){return z("Microphone permission was denied")},audioContext:B.current})]):[2];case 1:return e=r.sent(),L(!0),R&&(clearTimeout(G.current),$()),J.current&&X(),J.current=e.clone(),t=function(e,t){var n=new c;if(!s)return n;var o,r,i,a=(t=t||{}).smoothing||.1,l=t.interval||50,f=t.threshold,h=t.play,p=t.history||10,d=!0;u=t.audioContext||u||new s,(i=u.createAnalyser()).fftSize=512,i.smoothingTimeConstant=a,r=new Float32Array(i.frequencyBinCount),e.jquery&&(e=e[0]),e instanceof HTMLAudioElement||e instanceof HTMLVideoElement?(o=u.createMediaElementSource(e),void 0===h&&(h=!0),f=f||-50):(o=u.createMediaStreamSource(e),f=f||-50),o.connect(i),h&&i.connect(u.destination),n.speaking=!1,n.suspend=function(){return u.suspend()},n.resume=function(){return u.resume()},Object.defineProperty(n,"state",{get:function(){return u.state}}),u.onstatechange=function(){n.emit("state_change",u.state)},n.setThreshold=function(e){f=e},n.setInterval=function(e){l=e},n.stop=function(){d=!1,n.emit("volume_change",-100,f),n.speaking&&(n.speaking=!1,n.emit("stopped_speaking")),i.disconnect(),o.disconnect()},n.speakingHistory=[];for(var g=0;g<p;g++)n.speakingHistory.push(0);var m=function(){setTimeout(function(){if(d){var e=function(e,t){var n=-1/0;e.getFloatFrequencyData(t);for(var o=4,r=t.length;o<r;o++)t[o]>n&&t[o]<0&&(n=t[o]);return n}(i,r);n.emit("volume_change",e,f);var t=0;if(e>f&&!n.speaking){for(var o=n.speakingHistory.length-3;o<n.speakingHistory.length;o++)t+=n.speakingHistory[o];t>=2&&(n.speaking=!0,n.emit("speaking"))}else if(e<f&&n.speaking){for(o=0;o<n.speakingHistory.length;o++)t+=n.speakingHistory[o];0==t&&(n.speaking=!1,n.emit("stopped_speaking"))}n.speakingHistory.shift(),n.speakingHistory.push(0+(e>f)),m()}},l)};return m(),n}(J.current,{audioContext:B.current}),t.on("speaking",function(){m&&m(),clearTimeout(G.current)}),t.on("stopped_speaking",function(){v&&v(),k({exportWAV:!0,wavCallback:function(e){return Q({blob:e,continuous:h||!1})}})}),[2]}})})},$=function(){G.current=window.setTimeout(function(){L(!1),X(),k({exportWAV:!1})},R)},Q=function(e){var t=e.blob,n=e.continuous,s=new FileReader;s.readAsDataURL(t),s.onloadend=function(){return r(f,void 0,void 0,function(){var e,r,c,l,u,f,h,p,m;return i(this,function(i){switch(i.label){case 0:return e=s.result,(r=null===(p=B.current)||void 0===p?void 0:p.sampleRate)&&r>48e3&&(r=48e3),c={content:""},l=o({encoding:"LINEAR16",languageCode:"en-US",sampleRateHertz:r},g),u={config:l,audio:c},c.content=e.substr(e.indexOf(",")+1),[4,fetch("https://speech.googleapis.com/v1/speech:recognize?key=".concat(d),{method:"POST",body:JSON.stringify(u)})];case 1:return[4,i.sent().json()];case 2:return f=i.sent(),(null===(m=f.results)||void 0===m?void 0:m.length)>0&&(h=f.results[0].alternatives[0].transcript,O(function(e){return a(a([],e,!0),[h],!1)}),I(function(e){return a(a([],e,!0),[{speechBlob:t,transcript:h,timestamp:Math.floor(Date.now()/1e3)}],!1)})),n?K():(X(),L(!1)),[2]}})})}},X=function(){var e;null===(e=J.current)||void 0===e||e.getAudioTracks()[0].stop()};return{error:q,interimResult:P,isRecording:E,results:U?V:F,setResults:I,startSpeechToText:K,stopSpeechToText:function(){y&&!M?y.stop():(L(!1),X(),k({exportWAV:!0,wavCallback:function(e){return Q({blob:e,continuous:!1})}}))}}}navigator.brave&&navigator.brave.isBrave().then(function(e){e&&(y=null)}),A&&(y=new A);export{C as default};
//# sourceMappingURL=index.js.map
