import{useState as e,useRef as t,useEffect as n}from"react";var o,s=i;function i(){}i.mixin=function(e){var t=e.prototype||e;t.isWildEmitter=!0,t.on=function(e,t,n){this.callbacks=this.callbacks||{};var o=3===arguments.length,s=o?arguments[1]:void 0,i=o?arguments[2]:arguments[1];return i._groupName=s,(this.callbacks[e]=this.callbacks[e]||[]).push(i),this},t.once=function(e,t,n){var o=this,s=3===arguments.length,i=s?arguments[1]:void 0,a=s?arguments[2]:arguments[1];function r(){o.off(e,r),a.apply(this,arguments)}return this.on(e,i,r),this},t.releaseGroup=function(e){var t,n,o,s;for(t in this.callbacks=this.callbacks||{},this.callbacks)for(n=0,o=(s=this.callbacks[t]).length;n<o;n++)s[n]._groupName===e&&(s.splice(n,1),n--,o--);return this},t.off=function(e,t){this.callbacks=this.callbacks||{};var n,o=this.callbacks[e];return o?1===arguments.length?(delete this.callbacks[e],this):(-1!==(n=o.indexOf(t))&&(o.splice(n,1),0===o.length&&delete this.callbacks[e]),this):this},t.emit=function(e){this.callbacks=this.callbacks||{};var t,n,o,s=[].slice.call(arguments,1),i=this.callbacks[e],a=this.getWildcardCallbacks(e);if(i)for(t=0,n=(o=i.slice()).length;t<n&&o[t];++t)o[t].apply(this,s);if(a)for(n=a.length,t=0,n=(o=a.slice()).length;t<n&&o[t];++t)o[t].apply(this,[e].concat(s));return this},t.getWildcardCallbacks=function(e){this.callbacks=this.callbacks||{};var t,n,o=[];for(t in this.callbacks)n=t.split("*"),("*"===t||2===n.length&&e.slice(0,n[0].length)===n[0])&&(o=o.concat(this.callbacks[t]));return o}},i.mixin(i),"undefined"!=typeof window&&(o=window.AudioContext||window.webkitAudioContext);var a=null,r="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{},c=!!(r===r.window&&r.URL&&r.Blob&&r.Worker);function l(e,t){var n,o=this;if(t=t||{},c)return n=e.toString().trim().match(/^function\s*\w*\s*\([\w\s,]*\)\s*{([\w\W]*?)}$/)[1],new r.Worker(r.URL.createObjectURL(new r.Blob([n],{type:"text/javascript"})));this.self=t,this.self.postMessage=function(e){setTimeout((function(){o.onmessage({data:e})}),0)},setTimeout(e.bind(t,t),0)}l.prototype.postMessage=function(e){var t=this;setTimeout((function(){t.self.onmessage({data:e})}),0)};var u=l;class h{constructor(e,t){this.config={bufferLen:4096,numChannels:1,mimeType:"audio/wav",...t},this.recording=!1,this.callbacks={getBuffer:[],exportWAV:[]},this.context=e.context,this.node=(this.context.createScriptProcessor||this.context.createJavaScriptNode).call(this.context,this.config.bufferLen,this.config.numChannels,this.config.numChannels),this.node.onaudioprocess=e=>{if(this.recording){for(var t=[],n=0;n<this.config.numChannels;n++)t.push(e.inputBuffer.getChannelData(n));this.worker.postMessage({command:"record",buffer:t})}},e.connect(this.node),this.node.connect(this.context.destination);this.worker=new u((function(){let e,t,n,o=0,s=[];function i(){for(let e=0;e<t;e++)s[e]=[]}function a(e,t){let n=new Float32Array(t),o=0;for(let t=0;t<e.length;t++)n.set(e[t],o),o+=e[t].length;return n}function r(e,t,n){for(let o=0;o<n.length;o++)e.setUint8(t+o,n.charCodeAt(o))}this.onmessage=function(c){switch(c.data.command){case"init":l=c.data.config,e=l.sampleRate,t=l.numChannels,i(),n=e>48e3?48e3:e;break;case"record":!function(e){for(var n=0;n<t;n++)s[n].push(e[n]);o+=e[0].length}(c.data.buffer);break;case"exportWAV":!function(i){let c,l=[];for(let e=0;e<t;e++)l.push(a(s[e],o));c=2===t?function(e,t){let n=e.length+t.length,o=new Float32Array(n),s=0,i=0;for(;s<n;)o[s++]=e[i],o[s++]=t[i],i++;return o}(l[0],l[1]):l[0];let u=function(e){let o=new ArrayBuffer(44+2*e.length),s=new DataView(o);return r(s,0,"RIFF"),s.setUint32(4,36+2*e.length,!0),r(s,8,"WAVE"),r(s,12,"fmt "),s.setUint32(16,16,!0),s.setUint16(20,1,!0),s.setUint16(22,t,!0),s.setUint32(24,n,!0),s.setUint32(28,4*n,!0),s.setUint16(32,2*t,!0),s.setUint16(34,16,!0),r(s,36,"data"),s.setUint32(40,2*e.length,!0),function(e,t,n){for(let o=0;o<n.length;o++,t+=2){let s=Math.max(-1,Math.min(1,n[o]));e.setInt16(t,s<0?32768*s:32767*s,!0)}}(s,44,e),s}(function(t,n){if(n==e)return t;if(n>e)throw"downsampling rate show be smaller than original sample rate";var o=e/n,s=Math.round(t.length/o),i=new Float32Array(s),a=0,r=0;for(;a<i.length;){for(var c=Math.round((a+1)*o),l=0,u=0,h=r;h<c&&h<t.length;h++)l+=t[h],u++;i[a]=l/u,a++,r=c}return i}(c,n)),h=new Blob([u],{type:i});this.postMessage({command:"exportWAV",data:h})}(c.data.type);break;case"getBuffer":!function(){let e=[];for(let n=0;n<t;n++)e.push(a(s[n],o));this.postMessage({command:"getBuffer",data:e})}();break;case"clear":o=0,s=[],i()}var l}}),{}),this.worker.postMessage({command:"init",config:{sampleRate:this.context.sampleRate,numChannels:this.config.numChannels}}),this.worker.onmessage=e=>{let t=this.callbacks[e.data.command].pop();"function"==typeof t&&t(e.data.data)}}record(){this.recording=!0}stop(){this.recording=!1}clear(){this.worker.postMessage({command:"clear"})}getBuffer(e){if(!(e=e||this.config.callback))throw new Error("Callback not set");this.callbacks.getBuffer.push(e),this.worker.postMessage({command:"getBuffer"})}exportWAV(e,t){if(t=t||this.config.mimeType,!(e=e||this.config.callback))throw new Error("Callback not set");this.callbacks.exportWAV.push(e),this.worker.postMessage({command:"exportWAV",type:t})}static forceDownload(e,t){let n=(window.URL||window.webkitURL).createObjectURL(e),o=window.document.createElement("a");o.href=n,o.download=t||"output.wav";let s=document.createEvent("Event");s.initEvent("click",!0,!0),o.dispatchEvent(s)}}let f,g,d=h;function p({exportWAV:e,wavCallback:t}){d.stop(),f.getAudioTracks()[0].stop(),e&&t&&d.exportWAV((e=>t(e))),d.clear()}const m=window.AudioContext||window.webkitAudioContext,w=window.SpeechRecognition||window.webkitSpeechRecognition;let k;function b({continuous:i,crossBrowser:r,googleApiKey:c,googleCloudRecognitionConfig:l,onStartSpeaking:u,onStoppedSpeaking:w,speechRecognitionProperties:b={interimResults:!0},timeout:v=1e4,useOnlyGoogleCloud:y=!1,useLegacyResults:x=!0}){const[A,C]=e(!1),R=t(),[M,S]=e([]),[T,U]=e([]),[W,L]=e(),[B,E]=e(""),H=t(),V=t();n((()=>{r||k||E("Speech Recognition API is only available on Chrome and Edge browsers"),navigator?.mediaDevices?.getUserMedia||E("getUserMedia is not supported on this device/browser :("),!r&&!y||c||console.error("No google cloud API key was passed, google API will not be able to process speech"),R.current||(R.current=new m),x&&console.warn("react-hook-speech-to-text is using legacy results, pass useLegacyResults: false to the hook to use the new array of objects results. Legacy array of strings results will be removed in a future version.")}),[]);const F=async()=>{if(!y&&k)return void(()=>{if(k){i&&(k.continuous=!0);const{grammars:e,interimResults:t,lang:n,maxAlternatives:o}=b||{};e&&(k.grammars=e),n&&(k.lang=n),k.interimResults=t||!1,k.maxAlternatives=o||1,k.start(),k.onresult=e=>{const n=e.results[e.results.length-1],{transcript:o}=n[0],s=Math.floor(Date.now()/1e3);if(t)if(n.isFinal)L(void 0),U((e=>[...e,{transcript:o,timestamp:s}])),S((e=>[...e,o]));else{let t="";for(let n=e.resultIndex;n<e.results.length;n++)t+=e.results[n][0].transcript;L(t)}else U((e=>[...e,{transcript:o,timestamp:s}])),S((e=>[...e,o]))},k.onaudiostart=()=>C(!0),k.onend=()=>{C(!1)}}})();if(!r&&!y)return;"suspended"===R.current?.state&&R.current?.resume();const e=await async function({audioContext:e,errHandler:t,onStreamLoad:n}){try{const t=await navigator.mediaDevices.getUserMedia({audio:!0});return n&&n(),f=t,g=e.createMediaStreamSource(t),d=new h(g),d.record(),t}catch(e){console.log(e),t&&t()}}({errHandler:()=>E("Microphone permission was denied"),audioContext:R.current});C(!0),v&&(clearTimeout(H.current),D()),V.current&&O(),V.current=e.clone();const t=function(e,t){var n=new s;if(!o)return n;var i,r,c,l=(t=t||{}).smoothing||.1,u=t.interval||50,h=t.threshold,f=t.play,g=t.history||10,d=!0;a=t.audioContext||a||new o,(c=a.createAnalyser()).fftSize=512,c.smoothingTimeConstant=l,r=new Float32Array(c.frequencyBinCount),e.jquery&&(e=e[0]),e instanceof HTMLAudioElement||e instanceof HTMLVideoElement?(i=a.createMediaElementSource(e),void 0===f&&(f=!0),h=h||-50):(i=a.createMediaStreamSource(e),h=h||-50),i.connect(c),f&&c.connect(a.destination),n.speaking=!1,n.suspend=function(){return a.suspend()},n.resume=function(){return a.resume()},Object.defineProperty(n,"state",{get:function(){return a.state}}),a.onstatechange=function(){n.emit("state_change",a.state)},n.setThreshold=function(e){h=e},n.setInterval=function(e){u=e},n.stop=function(){d=!1,n.emit("volume_change",-100,h),n.speaking&&(n.speaking=!1,n.emit("stopped_speaking")),c.disconnect(),i.disconnect()},n.speakingHistory=[];for(var p=0;p<g;p++)n.speakingHistory.push(0);var m=function(){setTimeout((function(){if(d){var e=function(e,t){var n=-1/0;e.getFloatFrequencyData(t);for(var o=4,s=t.length;o<s;o++)t[o]>n&&t[o]<0&&(n=t[o]);return n}(c,r);n.emit("volume_change",e,h);var t=0;if(e>h&&!n.speaking){for(var o=n.speakingHistory.length-3;o<n.speakingHistory.length;o++)t+=n.speakingHistory[o];t>=2&&(n.speaking=!0,n.emit("speaking"))}else if(e<h&&n.speaking){for(o=0;o<n.speakingHistory.length;o++)t+=n.speakingHistory[o];0==t&&(n.speaking=!1,n.emit("stopped_speaking"))}n.speakingHistory.shift(),n.speakingHistory.push(0+(e>h)),m()}}),u)};return m(),n}(V.current,{audioContext:R.current});t.on("speaking",(()=>{u&&u(),clearTimeout(H.current)})),t.on("stopped_speaking",(()=>{w&&w(),p({exportWAV:!0,wavCallback:e=>I({blob:e,continuous:i||!1})})}))},D=()=>{H.current=window.setTimeout((()=>{C(!1),O(),p({exportWAV:!1})}),v)},I=({blob:e,continuous:t})=>{const n=new FileReader;n.readAsDataURL(e),n.onloadend=async()=>{const o=n.result;let s=R.current?.sampleRate;s&&s>48e3&&(s=48e3);const i={content:""},a={config:{encoding:"LINEAR16",languageCode:"en-US",sampleRateHertz:s,...l},audio:i};i.content=o.substr(o.indexOf(",")+1);const r=await fetch(`https://speech.googleapis.com/v1/speech:recognize?key=${c}`,{method:"POST",body:JSON.stringify(a)}),u=await r.json();if(u.results?.length>0){const{transcript:t}=u.results[0].alternatives[0];S((e=>[...e,t])),U((n=>[...n,{speechBlob:e,transcript:t,timestamp:Math.floor(Date.now()/1e3)}]))}t?F():(O(),C(!1))}},O=()=>{V.current?.getAudioTracks()[0].stop()};return{error:B,interimResult:W,isRecording:A,results:x?M:T,setResults:U,startSpeechToText:F,stopSpeechToText:()=>{k&&!y?k.stop():(C(!1),O(),p({exportWAV:!0,wavCallback:e=>I({blob:e,continuous:!1})}))}}}navigator.brave&&navigator.brave.isBrave().then((e=>{e&&(k=null)})),w&&(k=new w);export default b;
//# sourceMappingURL=index.js.map
